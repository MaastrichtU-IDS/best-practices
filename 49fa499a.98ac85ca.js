(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{136:function(e,t,i){"use strict";i.d(t,"a",(function(){return p})),i.d(t,"b",(function(){return h}));var n=i(0),a=i.n(n);function r(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function o(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function s(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?o(Object(i),!0).forEach((function(t){r(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function c(e,t){if(null==e)return{};var i,n,a=function(e,t){if(null==e)return{};var i,n,a={},r=Object.keys(e);for(n=0;n<r.length;n++)i=r[n],t.indexOf(i)>=0||(a[i]=e[i]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)i=r[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(a[i]=e[i])}return a}var l=a.a.createContext({}),u=function(e){var t=a.a.useContext(l),i=t;return e&&(i="function"==typeof e?e(t):s(s({},t),e)),i},p=function(e){var t=u(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},g=a.a.forwardRef((function(e,t){var i=e.components,n=e.mdxType,r=e.originalType,o=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),p=u(i),g=n,h=p["".concat(o,".").concat(g)]||p[g]||b[g]||r;return i?a.a.createElement(h,s(s({ref:t},l),{},{components:i})):a.a.createElement(h,s({ref:t},l))}));function h(e,t){var i=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=i.length,o=new Array(r);o[0]=g;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:n,o[1]=s;for(var l=2;l<r;l++)o[l]=i[l];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,i)}g.displayName="MDXCreateElement"},91:function(e,t,i){"use strict";i.r(t),i.d(t,"frontMatter",(function(){return s})),i.d(t,"metadata",(function(){return c})),i.d(t,"toc",(function(){return l})),i.d(t,"default",(function(){return p}));var n=i(3),a=i(7),r=(i(0),i(136)),o=["components"],s={title:"Hosting docker images for DSRI",author:"Tim Hendriks",author_title:"Software engineer at IDS",author_url:"https://github.com/thendriks",tags:["security","deployment","dsri","openshift","github","docker"],description:"On deploying (private) images on OpenShift using GitHub actions",hide_table_of_contents:!1},c={permalink:"/best-practices/blog/2021/01/19/private-image-openshift-deploy",source:"@site/blog/2021-1-19-private-image-openshift-deploy.md",description:"On deploying (private) images on OpenShift using GitHub actions",date:"2021-01-19T00:00:00.000Z",tags:[{label:"security",permalink:"/best-practices/blog/tags/security"},{label:"deployment",permalink:"/best-practices/blog/tags/deployment"},{label:"dsri",permalink:"/best-practices/blog/tags/dsri"},{label:"openshift",permalink:"/best-practices/blog/tags/openshift"},{label:"github",permalink:"/best-practices/blog/tags/github"},{label:"docker",permalink:"/best-practices/blog/tags/docker"}],title:"Hosting docker images for DSRI",readingTime:3.445,truncated:!0,prevItem:{title:"Publish Nanopublications",permalink:"/best-practices/blog/2021/01/19/usecase-nanopublication"},nextItem:{title:"Improve code security",permalink:"/best-practices/blog/2020/12/20/code-security"}},l=[{value:"GitHub Container Registry advantages",id:"github-container-registry-advantages",children:[]},{value:"Using GitHub Personal Access Tokens",id:"using-github-personal-access-tokens",children:[]},{value:"GHCR",id:"ghcr",children:[{value:"Publishing to GHCR with GitHub Actions",id:"publishing-to-ghcr-with-github-actions",children:[]},{value:"Setting permissions for the published image",id:"setting-permissions-for-the-published-image",children:[]}]},{value:"Deploying the image on DSRI",id:"deploying-the-image-on-dsri",children:[]}],u={toc:l};function p(e){var t=e.components,i=Object(a.a)(e,o);return Object(r.b)("wrapper",Object(n.a)({},u,i,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"When utilizing DockerHub on orchestration systems such as Kubernetes we run into download rate limits. We can circumvent these issues using a CI/CD workflow that leverages GitHub Container Registry."),Object(r.b)("h1",{id:"hosting-docker-images-for-dsri"},"Hosting Docker Images for DSRI"),Object(r.b)("p",null,"The initial choice for most Docker users will be to use DockerHub. However, when utilizing orchestration systems such as Kubernetes (in our case mostly DSRI and thus OpenShift) we quickly run into ",Object(r.b)("a",{parentName:"p",href:"https://docs.docker.com/docker-hub/download-rate-limit/"},"download rate limits"),". Below a workflow is suggested to circumvent these issues using the ",Object(r.b)("a",{parentName:"p",href:"https://docs.github.com/en/packages/guides/about-github-container-registry"},"GitHub Container Registry"),".\nAs with all documentation on this page, everything stated below can be used as a 'default' in lack of a better alternative. You can ofcourse deviate from any of the solutions mentioned but lacking good argumentation to do so using similar methodology is preferred. This will help create a common base of knowledge and for cooperation."),Object(r.b)("p",null,"The suggested workflow is as follows:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"Store the code and Dockerfile on a GitHub Repository."),Object(r.b)("li",{parentName:"ul"},"Add a GitHub Action workflow to publish the image to GitHub Packages."),Object(r.b)("li",{parentName:"ul"},"Link an OpenShift service user to a GitHub Personal Access Token."),Object(r.b)("li",{parentName:"ul"},"Leveraging the service user, apply an OpenShift configuration that pulls the image.")),Object(r.b)("h2",{id:"github-container-registry-advantages"},"GitHub Container Registry advantages"),Object(r.b)("p",null,"Some of the reasons to opt for the ",Object(r.b)("a",{parentName:"p",href:"https://docs.github.com/en/packages/guides/about-github-container-registry"},"GitHub Container Registry")," are:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"No download rate limit (Unlimited number of Docker pulls). Since platforms such as DSRI will perform a large number of pulls this is paramount."),Object(r.b)("li",{parentName:"ul"},"Integration with existing GitHub functionality:",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"Linking to the relevant GitHub repository."),Object(r.b)("li",{parentName:"ul"},"Providing documentation in markdown for the package."),Object(r.b)("li",{parentName:"ul"},"Utilizing Github users and groups for authorization on the image."))),Object(r.b)("li",{parentName:"ul"},"Storing code, CI/CD, packages and images on the same platform."),Object(r.b)("li",{parentName:"ul"},"Faster communication between the GitHub Actions server and GHCR servers.")),Object(r.b)("h2",{id:"using-github-personal-access-tokens"},"Using GitHub Personal Access Tokens"),Object(r.b)("p",null,"In order to allow automated calls to GitHub securely with specified permissions such as commands from CI/CD or OpenShift, a ",Object(r.b)("a",{parentName:"p",href:"https://docs.github.com/en/packages/guides/pushing-and-pulling-docker-images"},"Personal Access Token")," can be set. In this case, setting the permissions suggested on the page allows downloading and uploading of containers. This token can then be used in calls during CI/CD and when pulling from openshift to give access to the image. Using PATs allows us to specify specific tokens for each usecase and set the permission the tokens have. This will minimize security risks as well as the potential for costly mistakes. "),Object(r.b)("h2",{id:"ghcr"},"GHCR"),Object(r.b)("p",null,Object(r.b)("a",{parentName:"p",href:"https://docs.github.com/en/packages/guides/about-github-container-registry"},"GitHub Container Registry")," can be used to manage and host Docker images. In order to automatically publish our images we can use ",Object(r.b)("a",{parentName:"p",href:"https://github.com/features/actions"},"GitHub Actions"),"."),Object(r.b)("h3",{id:"publishing-to-ghcr-with-github-actions"},"Publishing to GHCR with GitHub Actions"),Object(r.b)("p",null,Object(r.b)("a",{parentName:"p",href:"https://github.com/features/actions"},"GitHub Actions")," allows for flexible CI/CD close to the repository. Publishing an image is a routine workflow, more information can be found ",Object(r.b)("a",{parentName:"p",href:"https://docs.github.com/en/actions/guides/publishing-docker-images"},"here"),". An IDS specific example can be found ",Object(r.b)("a",{parentName:"p",href:"https://github.com/MaastrichtU-IDS/translator-openpredict/blob/master/.github/workflows/publish-docker.yml"},"here"),"."),Object(r.b)("p",null,"Workflows such as these usually involve setting a ",Object(r.b)("a",{parentName:"p",href:"https://docs.github.com/en/actions/reference/encrypted-secrets"},"secret"),". These secrets can be set in the settings of the repository. In this case, a secret should be created that contains our PAT. This allows the defined GitHub action to use the PAT to publish the image."),Object(r.b)("h3",{id:"setting-permissions-for-the-published-image"},"Setting permissions for the published image"),Object(r.b)("p",null,"Packages are published to the MaastrichtU-IDS organization ",Object(r.b)("a",{parentName:"p",href:"https://github.com/orgs/MaastrichtU-IDS/packages"},"here"),". These packages are created automatically during the publishing process and do not have to be setup beforehand. After publishing, ",Object(r.b)("a",{parentName:"p",href:"https://docs.github.com/en/packages/learn-github-packages/about-github-packages#about-scopes-and-permissions-for-package-registries"},"permissions")," should be set to give users and groups access to the image. By default, add the IDS admin and IDS developer groups with admin and write privileges respectively."),Object(r.b)("h2",{id:"deploying-the-image-on-dsri"},"Deploying the image on DSRI"),Object(r.b)("p",null,"Images can be deployed to DSRI in multiple ways. One option is to ",Object(r.b)("a",{parentName:"p",href:"https://www.openshift.com/blog/deploying-applications-from-images-in-openshift-part-one-web-console"},"manually add the image stream")," in the DSRI interface. A better way is to store the configuration in yaml and deploy the entire configuration. An example configuration can be found ",Object(r.b)("a",{parentName:"p",href:"https://github.com/fairscape/deployment/blob/dev-ids/stardog.yaml"},"here"),". The image url can be set to the url obtained on the page for your specific package (ghcr.io/yourpackageurl)."),Object(r.b)("p",null,"In order to allow DSRI access to the (private) image we can leverage ",Object(r.b)("a",{parentName:"p",href:"https://docs.openshift.com/container-platform/4.1/openshift_images/managing_images/using-image-pull-secrets.html"},"image pull secrets"),".\nCreating a secret:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre"},"oc -n <project> create secret docker-registry <secret-name> --docker-server=ghcr.io --docker-username=<github-username> --docker-password=<github-personal-access-token> --docker-email=<email-address>\n")),Object(r.b)("p",null,"Linking a secret:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre"},"oc secrets link default <pull-secret-name> --for=pull\n")),Object(r.b)("p",null,"Where ",Object(r.b)("em",{parentName:"p"},"default")," is the name of the service account used to pull the image."))}p.isMDXComponent=!0}}]);