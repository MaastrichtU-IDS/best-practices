<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/best-practices/blog/rss.xml" title="IDS Best Practices Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/best-practices/blog/atom.xml" title="IDS Best Practices Blog Atom Feed">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:200,300,400,400i,500,600,700">
<script src="https://buttons.github.io/buttons.js"></script><title data-react-helmet="true">Hosting docker images for DSRI | IDS Best Practices</title><meta data-react-helmet="true" property="og:title" content="Hosting docker images for DSRI | IDS Best Practices"><meta data-react-helmet="true" name="description" content="On deploying (private) images on OpenShift using GitHub actions"><meta data-react-helmet="true" property="og:description" content="On deploying (private) images on OpenShift using GitHub actions"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/best-practices/img/favicon.ico"><link rel="stylesheet" href="/best-practices/styles.1406838e.css">
<link rel="preload" href="/best-practices/styles.d97c44a1.js" as="script">
<link rel="preload" href="/best-practices/runtime~main.ad392853.js" as="script">
<link rel="preload" href="/best-practices/main.613b3d93.js" as="script">
<link rel="preload" href="/best-practices/1.920342e0.js" as="script">
<link rel="preload" href="/best-practices/2.673afb60.js" as="script">
<link rel="preload" href="/best-practices/3.29025a67.js" as="script">
<link rel="preload" href="/best-practices/01a85c17.d2e86c8d.js" as="script">
<link rel="preload" href="/best-practices/1a4e3797.34a2598f.js" as="script">
<link rel="preload" href="/best-practices/1be78505.4bd55ab9.js" as="script">
<link rel="preload" href="/best-practices/6875c492.35910dc9.js" as="script">
<link rel="preload" href="/best-practices/a6aa9e1f.4476be05.js" as="script">
<link rel="preload" href="/best-practices/c4f5d8e4.76ba4281.js" as="script">
<link rel="preload" href="/best-practices/ccc49370.b4970ffd.js" as="script">
<link rel="preload" href="/best-practices/58.c3f7a682.js" as="script">
<link rel="preload" href="/best-practices/d3c81e4c.aa1cdc02.js" as="script">
<link rel="preload" href="/best-practices/49fa499a.3fa56864.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/best-practices/"><img src="/best-practices/img/favicon.ico" alt="Institute of Data Science" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/best-practices/img/favicon.ico" alt="Institute of Data Science" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Institute of Data Science</strong></a><a class="navbar__item navbar__link" href="/best-practices/docs/">Best practices</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/best-practices/blog/">Blog</a><a class="navbar__item navbar__link" href="/best-practices/contributing">Contribute</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/MaastrichtU-IDS/best-practices" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search searchBarContainer_1-U_"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_18Th searchBarLoadingRing_zYFK"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/best-practices/"><img src="/best-practices/img/favicon.ico" alt="Institute of Data Science" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/best-practices/img/favicon.ico" alt="Institute of Data Science" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Institute of Data Science</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/best-practices/docs/">Best practices</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/best-practices/blog/">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/best-practices/contributing">Contribute</a></li><li class="menu__list-item"><a href="https://github.com/MaastrichtU-IDS/best-practices" target="_blank" rel="noopener noreferrer" class="menu__link header-github-link"></a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a aria-current="page" class="sidebarItemLink_v5H9 sidebarItemLinkActive_1anX" href="/best-practices/blog/2021/01/19/private-image-openshift-deploy">Hosting docker images for DSRI</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/best-practices/blog/2020/12/20/code-security">Improve code security</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/best-practices/blog/2020/12/17/vscode-extensions">VisualStudio Code extensions</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/best-practices/blog/2020/12/15/create-webapp">Create a web app</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_3-lP">Hosting docker images for DSRI</h1><div class="margin-vert--md"><time datetime="2021-01-19T00:00:00.000Z" class="blogPostDate_Ta7i">January 19, 2021  Â· 4 min read</time></div><div class="avatar margin-vert--md"><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/thendriks" target="_blank" rel="noreferrer noopener">Tim Hendriks</a></h4><small class="avatar__subtitle">Software engineer at IDS</small></div></div></header><section class="markdown"><p>When utilizing DockerHub on orchestration systems such as Kubernetes we run into download rate limits. We can circumvent these issues using a CI/CD workflow that leverages GitHub Container Registry.</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="hosting-docker-images-for-dsri"></a>Hosting Docker Images for DSRI<a class="hash-link" href="#hosting-docker-images-for-dsri" title="Direct link to heading">#</a></h1><p>The initial choice for most Docker users will be to use DockerHub. However, when utilizing orchestration systems such as Kubernetes (in our case mostly DSRI and thus OpenShift) we quickly run into <a href="https://docs.docker.com/docker-hub/download-rate-limit/" target="_blank" rel="noopener noreferrer">download rate limits</a>. Below a workflow is suggested to circumvent these issues using the <a href="https://docs.github.com/en/packages/guides/about-github-container-registry" target="_blank" rel="noopener noreferrer">GitHub Container Registry</a>.
As with all documentation on this page, everything stated below can be used as a &#x27;default&#x27; in lack of a better alternative. You can ofcourse deviate from any of the solutions mentioned but lacking good argumentation to do so using similar methodology is preferred. This will help create a common base of knowledge and for cooperation.</p><p>The suggested workflow is as follows:</p><ul><li>Store the code and Dockerfile on a GitHub Repository.</li><li>Add a GitHub Action workflow to publish the image to GitHub Packages.</li><li>Link an OpenShift service user to a GitHub Personal Access Token.</li><li>Leveraging the service user, apply an OpenShift configuration that pulls the image.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="github-container-registry-advantages"></a>GitHub Container Registry advantages<a class="hash-link" href="#github-container-registry-advantages" title="Direct link to heading">#</a></h2><p>Some of the reasons to opt for the <a href="https://docs.github.com/en/packages/guides/about-github-container-registry" target="_blank" rel="noopener noreferrer">GitHub Container Registry</a> are:</p><ul><li>No download rate limit (Unlimited number of Docker pulls). Since platforms such as DSRI will perform a large number of pulls this is paramount.</li><li>Integration with existing GitHub functionality:<ul><li>Linking to the relevant GitHub repository.</li><li>Providing documentation in markdown for the package.</li><li>Utilizing Github users and groups for authorization on the image.</li></ul></li><li>Storing code, CI/CD, packages and images on the same platform.</li><li>Faster communication between the GitHub Actions server and GHCR servers.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="using-github-personal-access-tokens"></a>Using GitHub Personal Access Tokens<a class="hash-link" href="#using-github-personal-access-tokens" title="Direct link to heading">#</a></h2><p>In order to allow automated calls to GitHub securely with specified permissions such as commands from CI/CD or OpenShift, a <a href="https://docs.github.com/en/packages/guides/pushing-and-pulling-docker-images" target="_blank" rel="noopener noreferrer">Personal Access Token</a> can be set. In this case, setting the permissions suggested on the page allows downloading and uploading of containers. This token can then be used in calls during CI/CD and when pulling from openshift to give access to the image. Using PATs allows us to specify specific tokens for each usecase and set the permission the tokens have. This will minimize security risks as well as the potential for costly mistakes. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="ghcr"></a>GHCR<a class="hash-link" href="#ghcr" title="Direct link to heading">#</a></h2><p><a href="https://docs.github.com/en/packages/guides/about-github-container-registry" target="_blank" rel="noopener noreferrer">GitHub Container Registry</a> can be used to manage and host Docker images. In order to automatically publish our images we can use <a href="https://github.com/features/actions" target="_blank" rel="noopener noreferrer">GitHub Actions</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="publishing-to-ghcr-with-github-actions"></a>Publishing to GHCR with GitHub Actions<a class="hash-link" href="#publishing-to-ghcr-with-github-actions" title="Direct link to heading">#</a></h3><p><a href="https://github.com/features/actions" target="_blank" rel="noopener noreferrer">GitHub Actions</a> allows for flexible CI/CD close to the repository. Publishing an image is a routine workflow, more information can be found <a href="https://docs.github.com/en/actions/guides/publishing-docker-images" target="_blank" rel="noopener noreferrer">here</a>. An IDS specific example can be found <a href="https://github.com/MaastrichtU-IDS/translator-openpredict/blob/master/.github/workflows/publish-docker.yml" target="_blank" rel="noopener noreferrer">here</a>.</p><p>Workflows such as these usually involve setting a <a href="https://docs.github.com/en/actions/reference/encrypted-secrets" target="_blank" rel="noopener noreferrer">secret</a>. These secrets can be set in the settings of the repository. In this case, a secret should be created that contains our PAT. This allows the defined GitHub action to use the PAT to publish the image.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="setting-permissions-for-the-published-image"></a>Setting permissions for the published image<a class="hash-link" href="#setting-permissions-for-the-published-image" title="Direct link to heading">#</a></h3><p>Packages are published to the MaastrichtU-IDS organization <a href="https://github.com/orgs/MaastrichtU-IDS/packages" target="_blank" rel="noopener noreferrer">here</a>. These packages are created automatically during the publishing process and do not have to be setup beforehand. After publishing, <a href="https://docs.github.com/en/packages/learn-github-packages/about-github-packages#about-scopes-and-permissions-for-package-registries" target="_blank" rel="noopener noreferrer">permissions</a> should be set to give users and groups access to the image. By default, add the IDS admin and IDS developer groups with admin and write privileges respectively.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deploying-the-image-on-dsri"></a>Deploying the image on DSRI<a class="hash-link" href="#deploying-the-image-on-dsri" title="Direct link to heading">#</a></h2><p>Images can be deployed to DSRI in multiple ways. One option is to <a href="https://www.openshift.com/blog/deploying-applications-from-images-in-openshift-part-one-web-console" target="_blank" rel="noopener noreferrer">manually add the image stream</a> in the DSRI interface. A better way is to store the configuration in yaml and deploy the entire configuration. An example configuration can be found <a href="https://github.com/fairscape/deployment/blob/dev-ids/stardog.yaml" target="_blank" rel="noopener noreferrer">here</a>. The image url can be set to the url obtained on the page for your specific package (ghcr.io/yourpackageurl).</p><p>In order to allow DSRI access to the (private) image we can leverage <a href="https://docs.openshift.com/container-platform/4.1/openshift_images/managing_images/using-image-pull-secrets.html" target="_blank" rel="noopener noreferrer">image pull secrets</a>.
Creating a secret:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">oc -n &lt;project&gt; create secret docker-registry &lt;secret-name&gt; --docker-server=ghcr.io --docker-username=&lt;github-username&gt; --docker-password=&lt;github-personal-access-token&gt; --docker-email=&lt;email-address&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Linking a secret:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">oc secrets link default &lt;pull-secret-name&gt; --for=pull</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Where <em>default</em> is the name of the service account used to pull the image.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/best-practices/blog/tags/security">security</a><a class="margin-horiz--sm" href="/best-practices/blog/tags/deployment">deployment</a><a class="margin-horiz--sm" href="/best-practices/blog/tags/dsri">dsri</a><a class="margin-horiz--sm" href="/best-practices/blog/tags/openshift">openshift</a><a class="margin-horiz--sm" href="/best-practices/blog/tags/github">github</a><a class="margin-horiz--sm" href="/best-practices/blog/tags/docker">docker</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/best-practices/blog/2020/12/20/code-security"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Improve code security Â»</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#github-container-registry-advantages" class="table-of-contents__link">GitHub Container Registry advantages</a></li><li><a href="#using-github-personal-access-tokens" class="table-of-contents__link">Using GitHub Personal Access Tokens</a></li><li><a href="#ghcr" class="table-of-contents__link">GHCR</a><ul><li><a href="#publishing-to-ghcr-with-github-actions" class="table-of-contents__link">Publishing to GHCR with GitHub Actions</a></li><li><a href="#setting-permissions-for-the-published-image" class="table-of-contents__link">Setting permissions for the published image</a></li></ul></li><li><a href="#deploying-the-image-on-dsri" class="table-of-contents__link">Deploying the image on DSRI</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="text--center"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/" title="Creative Commons Attribution 4.0 International license" target="_blank"><img src="/best-practices/img/cc-by.svg" alt="cc by license"></a></div><div style="margin-bottom:10px">Copyright Â© 2020 <a href="https://maastrichtuniversity.nl/ids" target="_blank" rel="noopener noreferrer">Institute of Data Science</a> at Maastricht University</div></div></div></footer></div>
<script src="/best-practices/styles.d97c44a1.js"></script>
<script src="/best-practices/runtime~main.ad392853.js"></script>
<script src="/best-practices/main.613b3d93.js"></script>
<script src="/best-practices/1.920342e0.js"></script>
<script src="/best-practices/2.673afb60.js"></script>
<script src="/best-practices/3.29025a67.js"></script>
<script src="/best-practices/01a85c17.d2e86c8d.js"></script>
<script src="/best-practices/1a4e3797.34a2598f.js"></script>
<script src="/best-practices/1be78505.4bd55ab9.js"></script>
<script src="/best-practices/6875c492.35910dc9.js"></script>
<script src="/best-practices/a6aa9e1f.4476be05.js"></script>
<script src="/best-practices/c4f5d8e4.76ba4281.js"></script>
<script src="/best-practices/ccc49370.b4970ffd.js"></script>
<script src="/best-practices/58.c3f7a682.js"></script>
<script src="/best-practices/d3c81e4c.aa1cdc02.js"></script>
<script src="/best-practices/49fa499a.3fa56864.js"></script>
</body>
</html>